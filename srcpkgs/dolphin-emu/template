# Template file for 'dolphin-emu'
pkgname=dolphin-emu
version=5.0.19368
revision=1
#Version/hash pair can be found at https://dolphin-emu.org/download/
_dolphin_commit=dadbeb4bae7e7fa23af2b46e0add4143094dc107
_mgba_commit=8739b22fbc90fdf0b4f6612ef9c0520f0ba44a51
_zlib_ng_commit=ce01b1e41da298334f8214389cc9369540a7560f
_cubeb_commit=27d2a102b0b75d9e49d43bc1ea516233fb87d778
_sanitizers_cmake_commit=aab6948fa863bc1cbe5d0850bc46b9ef02ed4c1a
_implot_commit=d87512353495e7760e7fda7566a05beef7627d8f
_libspng_commit=dc5b1032c08efac68ad30170f7ccbf0aa8dd55c9
_rcheevos_commit=d9e990e6d13527532b7e2bb23164a1f3b7f33bb5
_googletest_commit=58d77fa8070e8cec2dc1ed015d66b454c8d78850
_VulkanMemoryAllocator_commit=498e20dfd1343d99b9115201034bb0219801cdec
archs="x86_64* aarch64* ppc64le* i686*"
create_wrksrc=yes
build_style=cmake
configure_args="-DUSE_SHARED_ENET=ON
 -DDOLPHIN_WC_DESCRIBE=${version%.*}-${version##*.}
 -DDOLPHIN_WC_REVISION=$_dolphin_commit
 -DDOLPHIN_WC_BRANCH=master"
hostmakedepends="pkg-config qt6-tools qt6-base"
makedepends="alsa-lib-devel bzip2-devel ffmpeg-devel fmt-devel gettext-devel git
 glew-devel gtest-devel hidapi-devel jack-devel libbluetooth-devel libcurl-devel
 libenet-devel libevdev-devel liblzma-devel libusb-devel libXi-devel
 libXrandr-devel libzstd-devel lzo-devel miniupnpc-devel pugixml-devel
 pulseaudio-devel qt6-base-devel SDL2-devel SFML-devel sndio-devel
 speexdsp-devel zlib-devel"
depends="desktop-file-utils"
short_desc="Gamecube / Wii / Triforce emulator"
maintainer="Henry Naguski <henry@nilsu.org>"
license="GPL-2.0-or-later"
homepage="http://dolphin-emu.org"
distfiles="https://github.com/dolphin-emu/dolphin/archive/${_dolphin_commit}.tar.gz
 https://github.com/mgba-emu/mgba/archive/${_mgba_commit}.tar.gz
 https://github.com/zlib-ng/zlib-ng/archive/${_zlib_ng_commit}.tar.gz
 https://github.com/mozilla/cubeb/archive/${_cubeb_commit}.tar.gz
 https://github.com/arsenm/sanitizers-cmake/archive/${_sanitizers_cmake_commit}.tar.gz
 https://github.com/epezent/implot/archive/${_implot_commit}.tar.gz
 https://github.com/randy408/libspng/archive/${_libspng_commit}.tar.gz
 https://github.com/RetroAchievements/rcheevos/archive/${_rcheevos_commit}.tar.gz
 https://github.com/google/googletest/archive/${_googletest_commit}.tar.gz
 https://github.com/GPUOpen-LibrariesAndSDKs/VulkanMemoryAllocator/archive/${_VulkanMemoryAllocator_commit}.tar.gz"
checksum="ef9af8103ec35808a6250b7eadda1a33877719ffb2aad2d65571843e7ae0f69a
 07e73f02198affccf83cc9740d377b78ba27866b0d654a5e55cafae69d1dfa1c
 64a6d355d2d5c9449fc047e5bb0ca32875fc385061dfaf1df3aa791577b7ff5e
 9326a22d41b30b6d613c248a8ea2eb56c5ffc76a7080b0127165682fd8eba13e
 9f5b073625375322236a94ce8d2d803cdedad321c91e63845f487b9ebfb2c433
 b85b27cde80816c6ecbd63390e5cb9d3ea56211a63564372b7a7f89fe5b76a9b
 2486cf203f8a201448ebd34949bc7f73038781a9099e205e55f1907fa91931bc
 dc165d4e7ce7b2b36169d94cc3291012e4b1fdf6a49b6b1d33c5126b289c888f
 c6ab3b6b33f51ef7465921f8f8c10c15d7cbc510761a15a18ad85babf6d73278
 4cb34c92b57d132d3200aa8c9b7f758e963eaeb31b6127d6edd0cd0902dc177e"
nopie=yes

case "$XBPS_TARGET_MACHINE" in
	x86_64*|aarch64*) ;;
	*) configure_args+=" -DENABLE_GENERIC=ON" ;;
esac

post_extract() {
	mv dolphin-${_dolphin_commit}/* .

	for lib in "cubeb" "implot" "libspng" "rcheevos"; do
		commit="_${lib}_commit"
		rmdir "Externals/$lib/$lib"
		mv $lib-${!commit} "Externals/$lib/$lib"
	done

	# some submodules are not as nicely behaved
	rmdir Externals/mGBA/mgba
	mv mgba-${_mgba_commit} Externals/mGBA/mgba
	rmdir Externals/zlib-ng/zlib-ng
	mv zlib-ng-${_zlib_ng_commit} Externals/zlib-ng/zlib-ng
	rmdir Externals/cubeb/cubeb/cmake/sanitizers-cmake
	mv sanitizers-cmake-${_sanitizers_cmake_commit} Externals/cubeb/cubeb/cmake/sanitizers-cmake
	rmdir Externals/gtest
	mv googletest-${_googletest_commit} Externals/gtest
	rmdir Externals/VulkanMemoryAllocator
	mv VulkanMemoryAllocator-${_VulkanMemoryAllocator_commit} Externals/VulkanMemoryAllocator
}

post_install() {
	rm -f ${DESTDIR}/usr/lib/*.a
}
